name: On Milestone PR Merged

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  check-and-run:
    # プルリクエストがマージされた場合のみ実行
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Check milestone
        id: check-milestone
        run: |
          MILESTONE="${{ github.event.pull_request.milestone.title }}"
          echo "Milestone: $MILESTONE"

          if [ "$MILESTONE" = "new version release" ]; then
            echo "milestone_matched=true" >> $GITHUB_OUTPUT
            echo "✓ Milestone 'new version release' detected"
          else
            echo "milestone_matched=false" >> $GITHUB_OUTPUT
            echo "✗ Milestone does not match. Current: '$MILESTONE'"
          fi

      - name: Run tasks for new version release
        if: steps.check-milestone.outputs.milestone_matched == 'true'
        run: |
          echo "==================================="
          echo "New Version Release Workflow"
          echo "==================================="
          echo "PR #${{ github.event.pull_request.number }} has been merged"
          echo "PR Title: ${{ github.event.pull_request.title }}"
          echo "Merged by: ${{ github.event.pull_request.merged_by.login }}"
          echo "Milestone: ${{ github.event.pull_request.milestone.title }}"
          echo ""
          echo "TODO: Add your release tasks here"
          echo "- Bump version"
          echo "- Create release tag"
          echo "- Generate release notes"
          echo "- Deploy to production"
          echo "==================================="

      - name: Checkout
        if: steps.check-milestone.outputs.milestone_matched == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Bump version
        if: steps.check-milestone.outputs.milestone_matched == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Git設定
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # 現在のminorバージョンを取得
          CURRENT_MINOR=$(grep "minor = " version.txt | awk '{print $3}')
          echo "Current minor version: $CURRENT_MINOR"

          # minorをインクリメント
          NEW_MINOR=$((CURRENT_MINOR + 1))
          echo "New minor version: $NEW_MINOR"

          # バージョンアップデート用のブランチ名を生成
          BRANCH_NAME="bump-version-minor-${NEW_MINOR}"
          echo "Branch name: $BRANCH_NAME"

          # ブランチを作成してチェックアウト
          git checkout -b "$BRANCH_NAME"

          # version.txtのminor値を更新
          sed -i.bak "s/minor = $CURRENT_MINOR/minor = $NEW_MINOR/" version.txt
          rm -f version.txt.bak

          # 変更を確認
          echo "Updated version.txt:"
          cat version.txt

          # 変更をコミット
          git add version.txt
          git commit -m "Bump minor version to $NEW_MINOR"

          # ブランチをプッシュ
          git push origin "$BRANCH_NAME"

          # プルリクエストを作成
          gh pr create \
            --title "Bump version: minor $CURRENT_MINOR → $NEW_MINOR" \
            --body "## Version Bump"
